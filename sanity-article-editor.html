<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>📝 Sanity記事エディター</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .header {
            text-align: center;
            background: #667eea;
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        .section {
            background: #f8f9fa;
            margin: 20px 0;
            padding: 25px;
            border-radius: 15px;
            border-left: 5px solid #667eea;
        }
        .section h3 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .form-group {
            margin: 15px 0;
        }
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            color: #2c3e50;
        }
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }
        .article-content {
            min-height: 400px;
            font-family: 'SF Mono', Monaco, monospace;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin: 8px;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        button:hover {
            background: #5a67d8;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #218838; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-warning:hover { background: #e0a800; }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }
        .btn-info { background: #17a2b8; }
        .btn-info:hover { background: #138496; }
        
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        @media (max-width: 768px) {
            .grid { grid-template-columns: 1fr; }
        }
        
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 600;
        }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .status.warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .status.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        
        .article-list {
            max-height: 300px;
            overflow-y: auto;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 10px;
        }
        .article-item {
            padding: 10px;
            border-bottom: 1px solid #e9ecef;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .article-item:hover {
            background-color: #f8f9fa;
        }
        .article-item.selected {
            background-color: #e3f2fd;
            border-left: 4px solid #667eea;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
        .loading.show {
            display: block;
        }
        
        .character-count {
            font-size: 12px;
            color: #6c757d;
            text-align: right;
            margin-top: 5px;
        }
        
        .preview-section {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📝 Sanity記事エディター</h1>
            <p>記事の検索、編集、更新を簡単に行えるツール</p>
            <p><strong>プロジェクトID:</strong> aoxze287 | <strong>データセット:</strong> production</p>
        </div>

        <!-- 記事検索セクション -->
        <div class="section">
            <h3>🔍 記事検索</h3>
            <div class="grid">
                <div class="form-group">
                    <label for="search-query">検索クエリ</label>
                    <input type="text" id="search-query" placeholder="記事タイトル、カテゴリ、または内容で検索">
                </div>
                <div class="form-group">
                    <label for="search-filter">フィルター</label>
                    <select id="search-filter">
                        <option value="all">すべて</option>
                        <option value="published">公開済み</option>
                        <option value="draft">下書き</option>
                        <option value="with-youtube">YouTube動画あり</option>
                        <option value="no-category">カテゴリなし</option>
                        <option value="short-content">短いコンテンツ</option>
                    </select>
                </div>
            </div>
            <button onclick="searchArticles()" class="btn-info">🔍 検索実行</button>
            <button onclick="loadRecentArticles()" class="btn-success">📅 最近の記事を読み込み</button>
        </div>

        <!-- 記事一覧セクション -->
        <div class="section">
            <h3>📋 記事一覧</h3>
            <div id="article-list" class="article-list">
                <div class="loading" id="loading">
                    <p>🔄 読み込み中...</p>
                </div>
            </div>
            <div class="status info">
                選択した記事: <span id="selected-article">なし</span>
            </div>
        </div>

        <!-- 記事編集セクション -->
        <div class="section">
            <h3>✏️ 記事編集</h3>
            
            <div class="grid">
                <div class="form-group">
                    <label for="article-title">タイトル</label>
                    <input type="text" id="article-title" placeholder="記事タイトル">
                </div>
                <div class="form-group">
                    <label for="article-category">カテゴリ</label>
                    <input type="text" id="article-category" placeholder="カテゴリ名">
                </div>
            </div>
            
            <div class="form-group">
                <label for="article-excerpt">概要 (Excerpt)</label>
                <textarea id="article-excerpt" placeholder="記事の概要を入力してください"></textarea>
                <div class="character-count" id="excerpt-count">0文字</div>
            </div>
            
            <div class="form-group">
                <label for="article-tags">タグ (カンマ区切り)</label>
                <input type="text" id="article-tags" placeholder="タグ1, タグ2, タグ3">
            </div>
            
            <div class="form-group">
                <label for="youtube-url">YouTube URL</label>
                <input type="url" id="youtube-url" placeholder="https://youtube.com/watch?v=...">
            </div>
            
            <div class="form-group">
                <label for="article-content">記事内容</label>
                <textarea id="article-content" class="article-content" placeholder="記事の内容をここに入力してください..."></textarea>
                <div class="character-count" id="content-count">0文字</div>
            </div>
        </div>

        <!-- プレビューセクション -->
        <div class="section">
            <h3>👁️ プレビュー</h3>
            <div class="preview-section" id="article-preview">
                <p class="status info">記事を選択してプレビューを表示</p>
            </div>
            <button onclick="generatePreview()" class="btn-info">👁️ プレビュー生成</button>
        </div>

        <!-- アクションセクション -->
        <div class="section">
            <h3>🚀 アクション</h3>
            <div class="grid">
                <div>
                    <button onclick="saveArticle()" class="btn-success">💾 記事を保存</button>
                    <button onclick="publishArticle()" class="btn-warning">📢 記事を公開</button>
                </div>
                <div>
                    <button onclick="duplicateArticle()" class="btn-info">📄 記事を複製</button>
                    <button onclick="deleteArticle()" class="btn-danger">🗑️ 記事を削除</button>
                </div>
            </div>
        </div>

        <!-- ログセクション -->
        <div class="section">
            <h3>📊 ログ</h3>
            <div id="log-area" style="background: #2d3748; color: #e2e8f0; padding: 20px; border-radius: 8px; font-family: monospace; height: 200px; overflow-y: auto;">
                <div>ログが表示されます...</div>
            </div>
            <button onclick="clearLog()" class="btn-warning">🧹 ログクリア</button>
        </div>
    </div>

    <script>
        let selectedArticleId = null;
        let articles = [];

        // ログ出力
        function log(message, type = 'info') {
            const logArea = document.getElementById('log-area');
            const time = new Date().toLocaleTimeString();
            const color = {
                info: '#17a2b8',
                success: '#28a745',
                warning: '#ffc107',
                error: '#dc3545'
            }[type] || '#17a2b8';
            
            const logEntry = document.createElement('div');
            logEntry.style.color = color;
            logEntry.innerHTML = `[${time}] ${message}`;
            logArea.appendChild(logEntry);
            logArea.scrollTop = logArea.scrollHeight;
        }

        // 文字数カウント
        function setupCharacterCount() {
            const excerptField = document.getElementById('article-excerpt');
            const contentField = document.getElementById('article-content');
            
            excerptField.addEventListener('input', () => {
                document.getElementById('excerpt-count').textContent = excerptField.value.length + '文字';
            });
            
            contentField.addEventListener('input', () => {
                document.getElementById('content-count').textContent = contentField.value.length + '文字';
            });
        }

        // 最近の記事を読み込み
        async function loadRecentArticles() {
            showLoading(true);
            log('最近の記事を読み込み中...', 'info');
            
            try {
                // この部分は実際のSanity APIクエリに置き換える必要があります
                const response = await mockApiCall('/api/articles/recent');
                articles = response.articles;
                displayArticles(articles);
                log(`${articles.length}件の記事を読み込みました`, 'success');
            } catch (error) {
                log(`記事の読み込みに失敗: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        // 記事検索
        async function searchArticles() {
            const query = document.getElementById('search-query').value;
            const filter = document.getElementById('search-filter').value;
            
            if (!query && filter === 'all') {
                log('検索クエリまたはフィルターを指定してください', 'warning');
                return;
            }
            
            showLoading(true);
            log(`検索実行: "${query}" (フィルター: ${filter})`, 'info');
            
            try {
                const response = await mockApiCall('/api/articles/search', { query, filter });
                articles = response.articles;
                displayArticles(articles);
                log(`${articles.length}件の記事が見つかりました`, 'success');
            } catch (error) {
                log(`検索に失敗: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        // 記事一覧表示
        function displayArticles(articles) {
            const listContainer = document.getElementById('article-list');
            listContainer.innerHTML = '<div class="loading" id="loading"><p>🔄 読み込み中...</p></div>';
            
            if (articles.length === 0) {
                listContainer.innerHTML = '<div class="status warning">記事が見つかりませんでした</div>';
                return;
            }
            
            const listHTML = articles.map(article => `
                <div class="article-item" onclick="selectArticle('${article._id}')">
                    <strong>${article.title || '無題'}</strong>
                    <div style="font-size: 12px; color: #6c757d;">
                        カテゴリ: ${article.category || 'なし'} | 
                        公開日: ${article.publishedAt ? new Date(article.publishedAt).toLocaleDateString('ja-JP') : '未公開'}
                        ${article.youtubeUrl ? ' | 📹 YouTube' : ''}
                    </div>
                </div>
            `).join('');
            
            listContainer.innerHTML = listHTML;
        }

        // 記事選択
        function selectArticle(articleId) {
            selectedArticleId = articleId;
            const article = articles.find(a => a._id === articleId);
            
            if (!article) {
                log('記事が見つかりません', 'error');
                return;
            }
            
            // 選択状態の表示更新
            document.querySelectorAll('.article-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.target.closest('.article-item').classList.add('selected');
            
            // フォームに記事データを設定
            document.getElementById('article-title').value = article.title || '';
            document.getElementById('article-category').value = article.category || '';
            document.getElementById('article-excerpt').value = article.excerpt || '';
            document.getElementById('article-tags').value = article.tags ? article.tags.join(', ') : '';
            document.getElementById('youtube-url').value = article.youtubeUrl || '';
            document.getElementById('article-content').value = article.bodyText || '';
            
            // 文字数更新
            document.getElementById('excerpt-count').textContent = (article.excerpt || '').length + '文字';
            document.getElementById('content-count').textContent = (article.bodyText || '').length + '文字';
            
            document.getElementById('selected-article').textContent = article.title || '無題';
            log(`記事を選択: ${article.title}`, 'success');
        }

        // プレビュー生成
        function generatePreview() {
            const title = document.getElementById('article-title').value;
            const category = document.getElementById('article-category').value;
            const excerpt = document.getElementById('article-excerpt').value;
            const tags = document.getElementById('article-tags').value;
            const youtubeUrl = document.getElementById('youtube-url').value;
            const content = document.getElementById('article-content').value;
            
            const previewHTML = `
                <h2>${title || '無題'}</h2>
                <div style="color: #6c757d; margin-bottom: 15px;">
                    <strong>カテゴリ:</strong> ${category || 'なし'} | 
                    <strong>タグ:</strong> ${tags || 'なし'}
                    ${youtubeUrl ? ' | <strong>YouTube:</strong> ✅' : ''}
                </div>
                <div style="background: #e9ecef; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <strong>概要:</strong> ${excerpt || '概要なし'}
                </div>
                <div style="white-space: pre-wrap; line-height: 1.6;">
                    ${content || 'コンテンツなし'}
                </div>
            `;
            
            document.getElementById('article-preview').innerHTML = previewHTML;
            log('プレビューを生成しました', 'success');
        }

        // 記事保存
        async function saveArticle() {
            if (!selectedArticleId) {
                log('保存するには記事を選択してください', 'warning');
                return;
            }
            
            const articleData = {
                title: document.getElementById('article-title').value,
                category: document.getElementById('article-category').value,
                excerpt: document.getElementById('article-excerpt').value,
                tags: document.getElementById('article-tags').value.split(',').map(tag => tag.trim()).filter(tag => tag),
                youtubeUrl: document.getElementById('youtube-url').value,
                bodyText: document.getElementById('article-content').value
            };
            
            log('記事を保存中...', 'info');
            
            try {
                await mockApiCall('/api/articles/update', { id: selectedArticleId, data: articleData });
                log('記事を保存しました', 'success');
            } catch (error) {
                log(`保存に失敗: ${error.message}`, 'error');
            }
        }

        // 記事公開
        async function publishArticle() {
            if (!selectedArticleId) {
                log('公開するには記事を選択してください', 'warning');
                return;
            }
            
            if (!confirm('この記事を公開しますか？')) {
                return;
            }
            
            log('記事を公開中...', 'info');
            
            try {
                await mockApiCall('/api/articles/publish', { id: selectedArticleId });
                log('記事を公開しました', 'success');
            } catch (error) {
                log(`公開に失敗: ${error.message}`, 'error');
            }
        }

        // 記事複製
        async function duplicateArticle() {
            if (!selectedArticleId) {
                log('複製するには記事を選択してください', 'warning');
                return;
            }
            
            log('記事を複製中...', 'info');
            
            try {
                const response = await mockApiCall('/api/articles/duplicate', { id: selectedArticleId });
                log(`記事を複製しました: ${response.newArticleId}`, 'success');
                await loadRecentArticles(); // 記事一覧を更新
            } catch (error) {
                log(`複製に失敗: ${error.message}`, 'error');
            }
        }

        // 記事削除
        async function deleteArticle() {
            if (!selectedArticleId) {
                log('削除するには記事を選択してください', 'warning');
                return;
            }
            
            if (!confirm('この記事を削除しますか？この操作は取り消せません。')) {
                return;
            }
            
            log('記事を削除中...', 'info');
            
            try {
                await mockApiCall('/api/articles/delete', { id: selectedArticleId });
                log('記事を削除しました', 'success');
                selectedArticleId = null;
                document.getElementById('selected-article').textContent = 'なし';
                await loadRecentArticles(); // 記事一覧を更新
            } catch (error) {
                log(`削除に失敗: ${error.message}`, 'error');
            }
        }

        // ローディング表示
        function showLoading(show) {
            const loading = document.getElementById('loading');
            if (show) {
                loading.classList.add('show');
            } else {
                loading.classList.remove('show');
            }
        }

        // ログクリア
        function clearLog() {
            document.getElementById('log-area').innerHTML = '<div>ログをクリアしました</div>';
        }

        // モックAPIコール（実際の実装ではSanity APIに置き換える）
        async function mockApiCall(endpoint, data = {}) {
            // 実際の実装では、ここでSanity APIを呼び出します
            return new Promise((resolve, reject) => {
                setTimeout(() => {
                    if (Math.random() > 0.1) { // 90%の確率で成功
                        resolve({
                            articles: [
                                {
                                    _id: '1',
                                    title: '【富山市】東京ディズニーリゾート40周年スペシャルパレード全国版 富山まつり2023',
                                    category: '富山市',
                                    excerpt: '2023年は東京ディズニーリゾートが開園してから40周年という記念すべき年でした...',
                                    tags: ['富山市', 'イベント', 'ディズニー'],
                                    youtubeUrl: 'https://youtube.com/watch?v=example',
                                    bodyText: 'ここに記事の本文が入ります...',
                                    publishedAt: '2023-10-15T10:00:00Z'
                                }
                            ],
                            newArticleId: 'new-article-id'
                        });
                    } else {
                        reject(new Error('API呼び出しに失敗しました'));
                    }
                }, 1000);
            });
        }

        // 初期化
        function init() {
            log('記事エディターを初期化しました', 'success');
            setupCharacterCount();
        }

        // ページ読み込み時に初期化
        window.onload = init;
    </script>
</body>
</html>