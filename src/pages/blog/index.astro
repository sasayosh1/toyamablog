---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { getAllBlogPosts } from '../../lib/sanity';

// Astroのコンテンツコレクションから取得
const blogEntries = await getCollection('blog');

// Sanityからブログ記事を取得（既存のpostタイプも含む）
let sanityPosts = [];
let existingPosts = [];
try {
  sanityPosts = await getAllBlogPosts();
  const { getAllPosts } = await import('../../lib/sanity');
  existingPosts = await getAllPosts();
} catch (error) {
  console.warn('Sanity posts could not be loaded:', error);
}

// 日付順にソート
const allPosts = [
  ...blogEntries.map(entry => ({
    ...entry.data,
    slug: entry.slug,
    source: 'astro'
  })),
  ...sanityPosts.map(post => ({
    title: post.title,
    description: post.description,
    pubDate: new Date(post.pubDate),
    tags: post.tags,
    heroImage: post.heroImage,
    slug: post.slug.current,
    source: 'sanity'
  })),
  ...existingPosts.map(post => ({
    title: post.title,
    description: post.description || post.text || '',
    pubDate: new Date(post.publishedAt || Date.now()),
    tags: post.tags,
    heroImage: null,
    slug: post.slug?.current || '',
    source: 'existing-post',
    category: post.category
  }))
].sort((a, b) => new Date(b.pubDate).getTime() - new Date(a.pubDate).getTime());
---

<BaseLayout title="ブログ一覧 - TOYAMA BLOG" description="TOYAMA BLOGの記事一覧ページ">
  <div style="margin-bottom: 3rem;">
    <h1 style="font-size: 2.5rem; margin-bottom: 1rem; text-align: center;">
      ブログ記事一覧
    </h1>
    <p style="text-align: center; color: #666; font-size: 1.125rem;">
      富山の魅力や日々の出来事について書いた記事をご覧いただけます。
    </p>
  </div>

  {allPosts.length > 0 ? (
    <div style="display: grid; gap: 2rem;">
      {allPosts.map((post) => (
        <article style="background: #f8f9fa; padding: 2rem; border-radius: 0.5rem; border: 1px solid #e9ecef;">
          <header style="margin-bottom: 1rem;">
            <h2 style="margin-bottom: 0.5rem;">
              <a 
                href={`/blog/${post.slug}/`}
                style="text-decoration: none; color: #333; font-size: 1.5rem;"
              >
                {post.title}
              </a>
            </h2>
            <div style="display: flex; align-items: center; gap: 1rem; color: #666; font-size: 0.875rem;">
              <time datetime={post.pubDate.toISOString()}>
                {post.pubDate.toLocaleDateString('ja-JP', {
                  year: 'numeric',
                  month: 'long',
                  day: 'numeric',
                })}
              </time>
              {post.source === 'sanity' && (
                <span style="background: #007acc; color: white; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem;">
                  Sanity CMS
                </span>
              )}
              {post.tags && post.tags.length > 0 && (
                <div style="display: flex; gap: 0.5rem;">
                  {post.tags.map((tag) => (
                    <span 
                      style="background: #e9ecef; padding: 0.25rem 0.5rem; border-radius: 0.25rem; font-size: 0.75rem;"
                    >
                      #{tag}
                    </span>
                  ))}
                </div>
              )}
            </div>
          </header>
          
          <p style="color: #666; line-height: 1.6; margin-bottom: 1rem;">
            {post.description}
          </p>
          
          <a 
            href={`/blog/${post.slug}/`}
            style="color: #333; text-decoration: none; font-weight: 500; display: inline-flex; align-items: center; gap: 0.5rem;"
          >
            続きを読む →
          </a>
        </article>
      ))}
    </div>
  ) : (
    <div style="text-align: center; padding: 4rem 2rem; background: #f8f9fa; border-radius: 0.5rem;">
      <h2 style="color: #666; margin-bottom: 1rem;">まだ記事がありません</h2>
      <p style="color: #666;">
        Sanity Studioで記事を作成するか、src/content/blog/ に Markdown ファイルを追加してください。<br>
        Sanity Studio: <a href="/studio" style="color: #007acc;">http://localhost:4321/studio</a>
      </p>
    </div>
  )}
</BaseLayout>