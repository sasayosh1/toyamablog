const { createClient } = require('@sanity/client');

const client = createClient({
  projectId: 'aoxze287',
  dataset: 'production',
  apiVersion: '2024-01-01',
  useCdn: false,
  token: process.env.SANITY_API_TOKEN
});

async function simplifyTocStructure() {
  try {
    const post = await client.fetch('*[_type == "post" && slug.current == "toyama-city-cake-station"][0] { _id, title, body }');
    
    if (!post) {
      console.log('è¨˜äº‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
      return;
    }
    
    console.log('H3è¦‹å‡ºã—ã‚’å‰Šé™¤ã—ã€H2ã®ã¿ã®æ§‹æˆã«å¤‰æ›´ä¸­...');
    console.log('æ–‡å­—æ•°ã‚’1000æ–‡å­—ã«è¿‘ã¥ã‘ã¾ã™...');
    
    // H2è¦‹å‡ºã—ã®ã¿ã®ç°¡ç´ åŒ–ã•ã‚ŒãŸæ§‹æˆï¼ˆæ–‡å­—æ•°ã‚’å¢—ã‚„ã—ã¦1000æ–‡å­—ã«è¿‘ã¥ã‘ã‚‹ï¼‰
    const simplifiedContent = [
      // å°Žå…¥æ–‡ï¼ˆç´„80æ–‡å­—ï¼‰
      {
        _type: 'block',
        _key: 'intro',
        style: 'normal',
        children: [{ _type: 'span', text: 'å¯Œå±±é§…å‰ã‚¨ãƒªã‚¢ã«ä½ç½®ã™ã‚‹ã€Œã‚·ãƒ£ãƒ«ãƒ­ãƒƒãƒ† ãƒ‘ãƒ†ã‚£ã‚ªã•ãã‚‰å¯Œå±±é§…å‰åº—ã€ã¯ã€åœ°å…ƒã®æ–¹ã€…ã«æ„›ã•ã‚Œç¶šã‘ã¦ã„ã‚‹éš ã‚Œå®¶çš„ãªã‚±ãƒ¼ã‚­åº—ã§ã™ã€‚é§…ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚‚æŠœç¾¤ã§ã€è·äººãŒå¿ƒã‚’è¾¼ã‚ã¦ä½œã‚‹çµ¶å“ã‚±ãƒ¼ã‚­ã‚’ã”ç´¹ä»‹ã—ã¾ã™ã€‚', marks: [] }],
        markDefs: []
      },
      
      // H2: æ¦‚è¦ï¼ˆç´„180æ–‡å­—ï¼‰
      {
        _type: 'block',
        _key: 'h2-overview',
        style: 'h2',
        children: [{ _type: 'span', text: 'ã‚·ãƒ£ãƒ«ãƒ­ãƒƒãƒ† ãƒ‘ãƒ†ã‚£ã‚ªã•ãã‚‰å¯Œå±±é§…å‰åº—ã®æ¦‚è¦', marks: [] }],
        markDefs: []
      },
      {
        _type: 'block',
        _key: 'overview-content',
        style: 'normal',
        children: [{ _type: 'span', text: 'å¯Œå±±é§…å‰ã®ä¾¿åˆ©ãªç«‹åœ°ã«ã‚ã‚ŠãªãŒã‚‰ã€è½ã¡ç€ã„ãŸé›°å›²æ°—ã§ã‚†ã£ãŸã‚Šã¨ã‚¹ã‚¤ãƒ¼ãƒ„ã‚’æ¥½ã—ã‚ã‚‹ç´ æ•µãªã‚±ãƒ¼ã‚­åº—ã§ã™ã€‚åº—åã®ã€Œã‚·ãƒ£ãƒ«ãƒ­ãƒƒãƒ†ã€ã¯ãƒ•ãƒ©ãƒ³ã‚¹èªžã§ã‚±ãƒ¼ã‚­ã®ä¸€ç¨®ã‚’æŒ‡ã—ã€ã€Œãƒ‘ãƒ†ã‚£ã‚ªã€ã¯ä¸­åº­ã‚’æ„å‘³ã™ã‚‹ã‚¹ãƒšã‚¤ãƒ³èªžã§ã€ãŠå®¢æ§˜ã«å¿ƒåœ°ã‚ˆã„ç©ºé–“ã§ã®æ™‚é–“ã‚’éŽã”ã—ã¦ã„ãŸã ããŸã„ã¨ã„ã†æƒ³ã„ãŒè¾¼ã‚ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚å¹…åºƒã„å±¤ã®ãŠå®¢æ§˜ã«æ„›ç”¨ã•ã‚Œã¦ã„ã‚‹éš ã‚Œå®¶çš„ã‚¹ãƒãƒƒãƒˆã¨ã—ã¦è¦ªã—ã¾ã‚Œã¦ã„ã¾ã™ã€‚', marks: [] }],
        markDefs: []
      },
      
      // H2: çµ¶å“ã‚±ãƒ¼ã‚­ï¼ˆç´„200æ–‡å­—ï¼‰
      {
        _type: 'block',
        _key: 'h2-cake',
        style: 'h2',
        children: [{ _type: 'span', text: 'çµ¶å“ã‚±ãƒ¼ã‚­ã¨è·äººã®ã“ã ã‚ã‚Š', marks: [] }],
        markDefs: []
      },
      {
        _type: 'block',
        _key: 'cake-content',
        style: 'normal',
        children: [{ _type: 'span', text: 'åŒ—æµ·é“ç”£ã®æ–°é®®ãªç”Ÿã‚¯ãƒªãƒ¼ãƒ ã‚„åµã€ãƒ¨ãƒ¼ãƒ­ãƒƒãƒ‘ã‹ã‚‰å–ã‚Šå¯„ã›ãŸä¸Šè³ªãªãƒãƒ§ã‚³ãƒ¬ãƒ¼ãƒˆã€åœ°å…ƒå¯Œå±±ã®ç¾Žå‘³ã—ã„ãŠæ°´ãªã©ã€åŽ³é¸ã•ã‚ŒãŸç´ æã®ã¿ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚é•·å¹´ã®çµŒé¨“ã‚’æŒã¤ãƒ‘ãƒ†ã‚£ã‚·ã‚¨ãŒã€ä¸€ã¤ä¸€ã¤æ‰‹ä½œã‚Šã§ä¸å¯§ã«ä»•ä¸Šã’ã¦ãŠã‚Šã€å­£ç¯€ã”ã¨ã«å¤‰ã‚ã‚‹ãƒ•ãƒ«ãƒ¼ãƒ„ã‚’ä½¿ã£ãŸã‚±ãƒ¼ã‚­ã‚‚å¤§å¤‰äººæ°—ã§ã™ã€‚ç‰¹ã«ã‚¯ãƒ©ã‚·ãƒƒã‚¯ãªã‚·ãƒ§ãƒ¼ãƒˆã‚±ãƒ¼ã‚­ã‚„æ¿ƒåŽšãªãƒãƒ§ã‚³ãƒ¬ãƒ¼ãƒˆã‚±ãƒ¼ã‚­ã¯ã€ä¸€åº¦é£Ÿã¹ãŸã‚‰å¿˜ã‚Œã‚‰ã‚Œãªã„ç¾Žå‘³ã—ã•ã§ã™ã€‚', marks: [] }],
        markDefs: []
      },
      
      // H2: åº—å†…ç’°å¢ƒï¼ˆç´„150æ–‡å­—ï¼‰
      {
        _type: 'block',
        _key: 'h2-interior',
        style: 'h2',
        children: [{ _type: 'span', text: 'å±…å¿ƒåœ°ã®è‰¯ã„åº—å†…ç’°å¢ƒ', marks: [] }],
        markDefs: []
      },
      {
        _type: 'block',
        _key: 'interior-content',
        style: 'normal',
        children: [{ _type: 'span', text: 'ã¾ã•ã«ã€Œéš ã‚Œå®¶ã€ã¨ã„ã†è¨€è‘‰ãŒã´ã£ãŸã‚Šã®è½ã¡ç€ã„ãŸé›°å›²æ°—ã§ã€æš–ã‹ã¿ã®ã‚ã‚‹ç…§æ˜Žã¨ä¸Šå“ãªã‚¤ãƒ³ãƒ†ãƒªã‚¢ãŒèª¿å’Œã—ãŸç©ºé–“ã§ã™ã€‚åº§å¸­æ•°ã¯é©åº¦ã«æŠ‘ãˆã‚‰ã‚Œã€ãŠå®¢æ§˜ä¸€äººä¸€äººãŒã‚†ã£ãŸã‚Šã¨ãã¤ã‚ã’ã‚‹ã‚ˆã†é…æ…®ã•ã‚Œã¦ã„ã¾ã™ã€‚ã‚¹ã‚¿ãƒƒãƒ•ã®ä¸å¯§ã§æ¸©ã‹ã„æŽ¥å®¢ã‚‚é­…åŠ›ã®ä¸€ã¤ã§ã€ã‚±ãƒ¼ã‚­é¸ã³ã«è¿·ã£ãŸæ™‚ã«ã¯è¦ªèº«ã«ãªã£ã¦ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ã—ã¦ãã‚Œã¾ã™ã€‚', marks: [] }],
        markDefs: []
      },
      
      // H2: ç«‹åœ°ï¼ˆç´„150æ–‡å­—ï¼‰
      {
        _type: 'block',
        _key: 'h2-location',
        style: 'h2',
        children: [{ _type: 'span', text: 'å¯Œå±±é§…å‰ã®ä¾¿åˆ©ãªç«‹åœ°', marks: [] }],
        markDefs: []
      },
      {
        _type: 'block',
        _key: 'location-content',
        style: 'normal',
        children: [{ _type: 'span', text: 'å¯Œå±±é§…ã‹ã‚‰å¾’æ­©ã™ãã¨ã„ã†æŠœç¾¤ã®ã‚¢ã‚¯ã‚»ã‚¹ã®è‰¯ã•ãŒæœ€å¤§ã®é­…åŠ›ã®ä¸€ã¤ã§ã™ã€‚é›»è»Šã‚„ãƒã‚¹ã§ã®æ¥åº—ã¯ã‚‚ã¡ã‚ã‚“ã€ãŠä»•äº‹å¸°ã‚Šã‚„è¦³å…‰ã®åˆé–“ã«ã‚‚æ°—è»½ã«ç«‹ã¡å¯„ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚å¯Œå±±é§…å‘¨è¾ºã¯å†é–‹ç™ºãŒé€²ã¿ã€ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°ã‚¹ãƒãƒƒãƒˆã‚„è¦³å…‰åœ°ã‚‚å……å®Ÿã—ã¦ã„ã‚‹ãŸã‚ã€ä¸€æ—¥ã®è¨ˆç”»ã«çµ„ã¿è¾¼ã¿ã‚„ã™ã„ç«‹åœ°ã¨ãªã£ã¦ã„ã¾ã™ã€‚å•†æ¥­æ–½è¨­ã¨èª¿å’Œã—ãŸé­…åŠ›çš„ãªã‚¨ãƒªã‚¢ã«ä½ç½®ã—ã¦ã„ã¾ã™ã€‚', marks: [] }],
        markDefs: []
      },
      
      // HTMLãƒ–ãƒ­ãƒƒã‚¯ï¼ˆGoogleãƒžãƒƒãƒ—ï¼‰ã‚’ä¿æŒ
      ...post.body.filter(block => block._type === 'html'),
      
      // H2: æ¥½ã—ã¿æ–¹ï¼ˆç´„120æ–‡å­—ï¼‰
      {
        _type: 'block',
        _key: 'h2-enjoy',
        style: 'h2',
        children: [{ _type: 'span', text: 'æ§˜ã€…ãªæ¥½ã—ã¿æ–¹', marks: [] }],
        markDefs: []
      },
      {
        _type: 'block',
        _key: 'enjoy-content',
        style: 'normal',
        children: [{ _type: 'span', text: 'ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼å¸­ã§ãŠä¸€äººã§ã‚†ã£ãã‚Šã¨ã‚±ãƒ¼ã‚­ã‚¿ã‚¤ãƒ ã‚’æ¥½ã—ã‚“ã ã‚Šã€å‹äººã‚„ã”å®¶æ—ã¨ã®å¤§åˆ‡ãªæ™‚é–“ã‚’éŽã”ã™å ´æ‰€ã¨ã—ã¦ã‚‚æœ€é©ã§ã™ã€‚ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆã«ã‚‚å¯¾å¿œã—ã¦ã„ã‚‹ãŸã‚ã€ã”è‡ªå®…ã‚„è·å ´ã§ã‚‚æ¥½ã—ã‚ã€å¤§åˆ‡ãªæ–¹ã¸ã®æ‰‹åœŸç”£ã¨ã—ã¦ã‚‚å–œã°ã‚Œã¾ã™ã€‚', marks: [] }],
        markDefs: []
      },
      
      // H2: ã¾ã¨ã‚ï¼ˆç´„120æ–‡å­—ï¼‰
      {
        _type: 'block',
        _key: 'h2-summary',
        style: 'h2',
        children: [{ _type: 'span', text: 'ã¾ã¨ã‚', marks: [] }],
        markDefs: []
      },
      {
        _type: 'block',
        _key: 'summary-content',
        style: 'normal',
        children: [{ _type: 'span', text: 'ã‚·ãƒ£ãƒ«ãƒ­ãƒƒãƒ† ãƒ‘ãƒ†ã‚£ã‚ªã•ãã‚‰å¯Œå±±é§…å‰åº—ã¯ã€å¯Œå±±é§…å‰ã¨ã„ã†ä¾¿åˆ©ãªç«‹åœ°ã§éš ã‚Œå®¶çš„é›°å›²æ°—ã‚’æ¥½ã—ã‚ã‚‹ç‰¹åˆ¥ãªã‚±ãƒ¼ã‚­åº—ã§ã™ã€‚è·äººã“ã ã‚ã‚Šã®çµ¶å“ã‚±ãƒ¼ã‚­ã¨æ¸©ã‹ã„ã‚µãƒ¼ãƒ“ã‚¹ã§ã€è¨ªã‚Œã‚‹äººã€…ã«è‡³ç¦ã®ã²ã¨ã¨ãã‚’æä¾›ã—ã¦ãã‚Œã¾ã™ã€‚ãœã²ä¸€åº¦è¶³ã‚’é‹ã‚“ã§ã€ç´ æ™´ã‚‰ã—ã„ã‚±ãƒ¼ã‚­ã¨å¿ƒæ¸©ã¾ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½“é¨“ã—ã¦ã¿ã¦ãã ã•ã„ã€‚', marks: [] }],
        markDefs: []
      }
    ];
    
    // æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ãƒˆ
    let totalChars = 0;
    simplifiedContent.forEach(block => {
      if (block._type === 'block' && block.children) {
        const text = block.children.map(child => child.text).join('');
        totalChars += text.length;
      }
    });
    
    console.log(`æ–°ã—ã„æ–‡å­—æ•°: ${totalChars}æ–‡å­—ï¼ˆç›®æ¨™: 1000æ–‡å­—ã«è¿‘ã¥ã‘ã‚‹ï¼‰`);
    
    // è¨˜äº‹ã‚’æ›´æ–°
    await client
      .patch(post._id)
      .set({ body: simplifiedContent })
      .commit();
    
    console.log('âœ… H3è¦‹å‡ºã—ã‚’å‰Šé™¤ã—ã€H2ã®ã¿ã®æ§‹æˆã«å¤‰æ›´ã—ã¾ã—ãŸ');
    console.log('ðŸ“‹ æ–°ã—ã„TOCæ§‹é€ : H2è¦‹å‡ºã—6å€‹ã®ã‚·ãƒ³ãƒ—ãƒ«ãªæ§‹æˆ');
    
    // æ›´æ–°å¾Œã®è¦‹å‡ºã—ç¢ºèª
    const updatedPost = await client.fetch('*[_type == "post" && slug.current == "toyama-city-cake-station"][0] { body }');
    const headings = updatedPost.body.filter(block => block.style === 'h2' || block.style === 'h3');
    
    console.log('\næ–°ã—ã„è¦‹å‡ºã—ä¸€è¦§:');
    headings.forEach((block, index) => {
      const text = block.children?.map(child => child.text).join('');
      console.log(`${index + 1}. ${block.style.toUpperCase()}: ${text}`);
    });
    
  } catch (error) {
    console.error('ã‚¨ãƒ©ãƒ¼:', error);
  }
}

simplifyTocStructure();