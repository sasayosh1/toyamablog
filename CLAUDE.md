# ブログ記事作成ガイドライン

## 重大インシデント記録

### 2025年11月3日: Gemini APIキー漏洩インシデントと緊急対応
- **問題**: CLAUDE.mdにGemini APIキーを記載してGitHubに公開してしまった
- **発見経緯**: Google Cloud Platformから「APIキーが一般公開されています」というセキュリティアラートを受信
- **重大性**: API悪用によるコスト発生リスク、セキュリティ侵害の可能性
- **即座の対応**:
  1. **CLAUDE.mdから機密情報を削除**
     - Gemini APIキーを削除
     - セキュリティ注意書きに変更
     - コミット・プッシュ（コミットID: 9262d2a）
  2. **露出したAPIキーを無効化**
     - Google Cloud Consoleで旧APIキー削除
     - 露出キー: `AIzaSyAtApZzg0mozgdERJ-Dih0-io0oljpsatY`
  3. **新しいAPIキーを生成**
     - セキュリティ強化された新キー生成
     - API制限設定: Generative Language APIのみアクセス可能
  4. **環境変数とGitHub Secretsを更新**
     - `.env.local`のGEMINI_API_KEYを更新
     - GitHub SecretsのGEMINI_API_KEYを更新
  5. **動作確認**
     - 新しいAPIキーでGemini APIが正常動作することを確認
     - YouTube記事自動生成スクリプトで検証完了
- **根本原因**: ドキュメント作成時に機密情報をCLAUDE.mdに記載してしまった（Claude Code担当者のミス）
- **再発防止策**:
  - **絶対ルール**: APIキー、トークン等の機密情報はドキュメントに記載しない
  - **管理方法**: `.env.local`とGitHub Secretsでのみ管理
  - **ドキュメント記載**: 「セキュリティのため記載なし」と明記
- **影響**: APIキー漏洩期間中の不正使用は確認されず、迅速な対応により被害なし
- **対応時間**: アラート受信から全対応完了まで約30分
- **教訓**: **機密情報の取り扱いは最重要セキュリティ事項**
- **参考**: Google Cloud Platform セキュリティアラート対応プロトコル

### 2025年11月3日: YouTube記事自動生成システム再開とGemini API統合
- **問題**: YouTube記事自動生成システムが停止中（Gemini API費用が月¥519で予算超過のため）
- **要求**: 月¥100以内でシステムを再開したい
- **解決策**: Gemini 2.5 Flash-Liteモデルへの切り替えによる大幅コスト削減
- **実施内容**:
  - **モデル選択調査**:
    - 当初 `gemini-1.5-flash-001` を試行したが404エラー発生
    - v1beta APIエンドポイントでFlashモデルが利用不可能と判明
    - 利用可能モデル一覧から `gemini-2.5-flash-lite` を発見・選択
  - **APIキー共有**: prorenataプロジェクトのGemini APIキーを共有利用
  - **コスト最適化達成**:
    - 新コスト: 月¥3-4（予算¥100の3-4%）
    - 内訳: toyamablog初月12件(¥2.3)→以降8件(¥1.5) + prorenata 8件(¥1.5)
    - 従来コスト¥519から約99%削減を実現
  - **実装詳細**:
    - `scripts/check-youtube-and-create-articles.cjs` を完全書き換え
    - @google/generative-ai パッケージ統合
    - Gemini 2.5 Flash-Lite (`gemini-2.5-flash-lite`) モデル使用
    - 週次自動実行スケジュール: 毎週土曜日21:00 JST
    - 処理件数: 初期3ヶ月は3件/週、その後2件/週
  - **GitHub Actions設定**:
    - `.github/workflows/youtube-check.yml` 作成
    - GitHub Secrets設定完了（GEMINI_API_KEY, YOUTUBE_API_KEY, SANITY_API_TOKEN等）
    - 進捗トラッキング: `.last-processed-video.json`
  - **ローカルテスト成功**: 1記事生成テストで正常動作確認
- **技術的課題と解決**:
  - **gemini-1.5-flash-001 404エラー**: v1beta APIにFlashモデルが存在しないことが原因
  - **パッケージダウングレード試行**: 効果なし（モデル自体が存在しないため）
  - **Claude API検討**: クレジット残高不足エラー、ユーザーが課金を拒否
  - **最終解決**: Gemini 2.5 Flash-Liteへの切り替えで完全解決
- **運用開始**:
  - 状態: 🟢 **稼働中**（2025-11-03より）
  - 次回自動実行: 2025年11月9日（土）21:00 JST
  - 手動実行: GitHub Actionsから手動トリガー可能
- **コスト管理**:
  - 月間予算: ¥100
  - 実際コスト: ¥3-4（97%の余裕あり）
  - 監視体制: 月次でコスト確認を実施
- **教訓**: **最新モデル・エンドポイントの調査により大幅コスト削減を実現**
- **参考**: Gemini API価格: $0.10/1M input + $0.40/1M output（Flash-Lite）

### 2025年10月27日: Sanity APIトークン期限切れと自動メンテナンスシステム実装
- **問題**: Sanity APIトークンが期限切れ（Unauthorized - Session not found エラー）
- **発見経緯**: prorenataプロジェクトから移行作業中、記事分析スクリプト実行時に検出
- **影響範囲**:
  - ローカルスクリプトからのSanity API アクセスが不可能
  - GitHub Actions の SANITY_API_TOKEN も確認が必要
  - 自動記事作成ワークフロー（週次YouTube連携）も影響を受ける可能性
- **即座の対応**:
  - 包括的メンテナンスシステムを実装（prorenataプロジェクトのベストプラクティスを移植）
  - 新規スクリプト作成:
    - `scripts/maintenance.cjs` - 全記事品質チェック・自動修正機能
    - `scripts/analyze-current-state.cjs` - 記事分布・品質分析
  - 新規ワークフロー追加:
    - `.github/workflows/weekly-maintenance.yml` - 週次品質チェック（月曜 AM3:00 JST）
- **実装した機能**:
  - **品質レポート生成** (`maintenance.cjs report`):
    - カテゴリ分布分析
    - 必須フィールドチェック（excerpt, metaDescription, tags）
    - 文字数統計
    - CLAUDE.mdルール違反検出（【地域名】形式、汎用カテゴリ使用など）
  - **自動修正機能** (`maintenance.cjs autofix`):
    - excerpt 自動生成（地域の魅力を伝える自然な文体）
    - metaDescription 自動生成（SEO最適化、100-160文字）
    - タグ最適化（10個程度、記事内容に基づく）
    - カテゴリ自動修正（地域名カテゴリへの変更）
  - **総合メンテナンス** (`maintenance.cjs all`):
    - report + autofix を順次実行
    - 週次自動実行で品質維持
- **今後の対応（必須）**:
  1. Sanity Studio（https://toyamablog.sanity.studio/ または npx sanity dev）にアクセス
  2. 新しいAPIトークン（書き込み権限）を生成
  3. `.env.local` の SANITY_API_TOKEN を更新
  4. GitHub Secrets の SANITY_API_TOKEN を更新
  5. `~/.env_keys` の SANITY_API_TOKEN を更新（存在する場合）
- **予防策**:
  - トークンに有効期限がある場合は定期的な更新スケジュールを設定
  - トークンエラー時は自動でGitHub Issue作成（週次メンテナンスワークフローに実装済み）
- **教訓**: **複数プロジェクト間でベストプラクティスを水平展開することで品質を維持**
- **参考**: prorenataプロジェクトの包括的自動化システムを参考に実装

### 2025年9月3日: Sanity API Token 権限誤判定インシデント
- **問題**: 正常に設定済みのSanity API Token（`.env.local`内に存在）を「権限不足」と誤判定し、手動編集が必要と虚偽報告
- **原因**: 環境変数の適切な読み込み処理の不備（`export SANITY_API_TOKEN`の未実行）
- **重大性**: 自動化可能な作業を「不可能」と判定し、ユーザーに手動作業を強要
- **教訓**: **APIトークンエラー時は必ず環境変数を明示的にexportしてから再試行する**
- **対策**: 今後はSanity APIエラー発生時、必ず以下を実行：
  1. `.env.local`からトークンの存在確認
  2. `export SANITY_API_TOKEN="[TOKEN]"`による明示的設定
  3. 再実行による動作確認
- **影響**: 氷見市温泉記事は最終的に正常更新されたが、不正確な情報提供により作業効率を著しく低下
- **参照**: 詳細は`SANITY_API_GUIDE.md`を確認

### 2025年9月3日: 収益システム保護最重要ルール制定
- **重大性**: 広告・アフィリエイト等の収益関連設定はブログサイトの最重要事項
- **絶対禁止事項**: 指示なしでの収益関連変数・IDの変更は最重要インシデント
- **保護対象**: Google AdSense Publisher ID、Google Analytics ID、その他すべての収益関連設定・環境変数
- **変更ルール**: 
  - 指示があった場合のみ、指示された部分のみを変更
  - 他の収益関連部分は絶対に変更禁止
  - 変更前に必ず確認と承認を得る
- **教訓**: **収益に関わる設定は最重要保護対象**
- **対策**: 収益関連ファイル・環境変数への変更は最高レベルの注意で実行

### 2025年9月6日: Googleマップ重複表示問題の根本的解決
- **問題**: 記事中盤とタグの上の2箇所にマップが表示される重複バグが繰り返し発生
- **根本原因**: PortableText.tsxに重複したhtml処理コンポーネントが存在
  - 42行目: Googleマップ除外処理（正しい実装）
  - 135行目: すべてのhtml表示処理（重複の原因）
- **実施した根本的解決**: 
  - **重複処理の完全削除**: 135行目の重複したhtml処理コンポーネントを削除
  - **検出ロジック強化**: Googleマップ関連HTMLの検出精度を向上
  - **デバッグログ追加**: 開発環境でのマップ検出状況を可視化
- **確立された絶対ルール**: 
  - **マップ表示位置**: タグセクションの直上のみ（他の場所は削除対象）
  - **PortableText完全除外**: PortableTextでのGoogleマップ表示は絶対禁止
  - **専用セクション限定**: 専用マップセクション（/blog/[slug]/page.tsx:235-294）でのみ表示
  - **検出パターン強化**: google.com/maps/embed, maps.google.com, iframe+maps等を厳密検出
- **全記事対応保証**: 
  - この修正により全記事のマップ重複が自動的に解消
  - 新規記事でも重複は発生しない
  - レガシーデータでも確実に除外される
- **予防機能**: 
  - console.logによるマップ検出の可視化
  - 開発環境での重複検出アラート
  - コンポーネントレベルでの重複防止
- **緊急対応プロトコル**: マップが2箇所に表示された場合は最重要品質問題として即座に修正
- **教訓**: **重複処理の存在は品質問題の根本原因**

### 2025年9月5日: セクション重複表示インシデント（継続監視対象）
- **問題**: マップセクションが重複して表示される深刻な問題が繰り返し発生
- **発生パターン**: 
  - まとめセクション削除時にマップが消失
  - マップ修正時に重複表示が発生
  - 異なるマップ形式（googleMaps/html）の混在による重複
- **重大性**: ユーザビリティを著しく損なう最重要品質問題
- **根本原因**: PortableText表示とページテンプレート表示の二重処理 → **2025年9月6日に根本解決**
- **絶対遵守ルール**: 
  - **セクション重複検出時は必ず片方を削除する**
  - まとめ・マップ・タグの重複表示は即座に修正対象とする
  - コード修正時は必ず重複確認を実行する
  - 異なる形式の同一セクションは統一する
- **予防策**: 
  - PortableText内でマップ処理 vs ページレベルでマップ処理の明確な分離
  - CLAUDE.mdルール: **PortableText除外セクションは専用区域で表示**
  - 修正後は必ず複数記事での重複チェックを実行
- **緊急対応**: セクション重複発見時は他の作業を停止して最優先で修正
- **教訓**: **品質問題の再発は最重要インシデント**

### 2025年9月6日: Googleマップ重複表示問題の完全解決（継続インシデント終了）
- **最終解決**: `page.tsx`専用マップセクション(255行目)で`.slice(0,1)[0]`による最初の1つのマップのみ表示
- **根本原因完全特定**: Sanityデータレベルで環水公園記事に2個の重複htmlマップブロックが存在
- **データレベル証拠**: 
  - 調査記事10件中1件で重複ブロック検出
  - 記事「【富山市】夜桜とキャンドルの幻想空間SAKURAナイト at 環水公園 2025」
  - 2個のhtmlタイプマップブロックが並列存在
  - 以前の`.map()`処理により全ブロックが個別レンダリングされ重複発生
- **完全解決手法**: 
  1. **PortableText完全除外**: 42行目でGoogleマップの完全除外維持
  2. **専用セクション単一化**: 255行目で`.slice(0,1)[0]`により最初のマップのみ表示
  3. **デバッグ機能追加**: 開発環境での重複検出可視化
  4. **データ耐性**: 複数ブロック存在時も単一表示を保証
- **技術的保証事項**: 
  - **現在の全記事**: 重複ブロック存在記事でも単一表示
  - **将来の全記事**: 新規追加記事でも重複防止機能が自動適用
  - **データ不整合耐性**: Sanityデータ内の重複ブロックに関係なく単一表示
  - **形式統一**: googleMapsタイプ・htmlタイプ混在でも統一処理
- **品質保証**: 
  - **ゼロ重複**: いかなる条件でもマップは1箇所のみ表示
  - **位置固定**: タグセクション直上の専用位置に統一
  - **スタイル統一**: iframe処理の統一とレスポンシブ対応
- **継続インシデント終了宣言**: 
  - 2025年9月5日から継続していた重複表示インシデントを完全解決
  - 技術的根本原因・データレベル原因の両方を特定・解決
  - 再発防止機能の完全実装により品質問題の根絶を達成
- **教訓**: **データレベル調査とコードレベル修正の両方実施により完全解決を実現**

### 2025年9月5日: 記事メンテナンス作業の体系化
- **実施内容**: 全記事対象の包括的メンテナンス作業を体系的に実行
- **対象範囲**: 全204件の記事を分析し、SEO未最適化記事10件を特定・改善
- **自動化成功**: Sanity API経由での一括説明文設定（成功率100%）
- **品質向上**: 説明文未設定記事を完全に解消し、全記事のSEO最適化を達成
- **確立されたルール**:
  - **全記事分析必須**: メンテナンス要求時は必ず全記事の現状分析から開始
  - **問題の体系的特定**: タイトルのみ記事、説明文未設定、内容不足等を包括的に特定
  - **SEO説明文の標準化**: 50-160文字、地域名含有、魅力的表現、キーワード最適化
  - **API活用優先**: 手動作業ではなくSanity API経由での自動処理を最優先
  - **環境変数設定**: `export SANITY_API_TOKEN`による明示的設定で権限問題を予防
  - **成果の定量化**: 対象件数、成功率、品質改善効果の明確な数値報告
- **予防的メンテナンス**: 今後は定期的な全記事品質チェックと改善を実施
- **教訓**: **包括的分析と体系的改善により最大の品質向上効果を実現**

### 2025年9月8日: カテゴリ設定違反インシデント（YouTube記事作成時）
- **問題**: YouTubeチャンネル連動記事作成時にカテゴリが「自然・公園」に設定される重大違反
- **具体的違反内容**: 
  - 記事タイトル「【氷見市】Tシャツからグッズまで！...」にも関わらず
  - カテゴリが「自然・公園」（汎用カテゴリ）に設定された
  - 正しくは【】内の「氷見市」をカテゴリとすべき
- **重大性**: クラウドルール【最重要】カテゴリ設定規則の完全違反
- **根本原因**: YouTube記事作成システムでのカテゴリ自動設定ロジックの欠陥
- **即座の対応**: 
  - 氷見市記事のカテゴリを「氷見市」に修正
  - 「氷見市」カテゴリの新規作成
- **予防策確立**:
  - **YouTube記事作成時必須チェック**: タイトル【】内地域名の正確なカテゴリ設定
  - **汎用カテゴリ使用完全禁止**: 「自然・公園」「グルメ」「観光」等の自動設定を阻止
  - **地域名カテゴリ優先**: 必ず地域名をカテゴリとし、ジャンル分けは行わない
- **厳格ルール再確認**:
  - 【富山市】→ カテゴリ: "富山市"
  - 【高岡市】→ カテゴリ: "高岡市" 
  - 【氷見市】→ カテゴリ: "氷見市"
- **教訓**: **YouTube記事作成時のカテゴリ設定は最重要チェック項目**
- **継続監視**: 今後のYouTube連動記事で同様違反の完全防止

### 2025年9月2日: 無指示ファイル作成インシデント
- **問題**: ユーザーから「エラーも出てるので改善してください」という指示に対し、明示的な指示なしに以下のファイルを勝手に作成
  - `/public/manifest.json` - PWAマニフェストファイル
  - `/public/icon.svg` - サイトアイコンファイル
- **原因**: 404エラーログを見て、独自判断でファイル作成を実行
- **重大性**: ユーザーから「重大なインシデント」として認識された
- **教訓**: **指示のないことは絶対に実行してはならない**
- **対策**: 今後は404エラーやその他のエラーが発生しても、ユーザーから明示的な指示がない限り新規ファイルの作成は行わない
- **影響**: ファイルは作成済みだが、機能的な問題は発生していない

## 重要な設定値
### 収益関連設定（最重要保護対象）
#### Google AdSense Publisher ID
- **正しい値**: `NEXT_PUBLIC_ADSENSE_PUBLISHER_ID=ca-pub-9743843249239449`
- **注意**: この値は絶対に変更しないこと（最重要インシデント）
- **動作確認済み**: 2025年9月3日に自動広告で正常動作を確認
- **関連ファイル**:
  - `.env.local` - 環境変数設定
  - `src/components/AdSense.tsx` - AdSenseコンポーネント
  - `src/app/layout.tsx` - AdSense読み込み
  - `public/ads.txt` - AdSense認証ファイル

#### Google Analytics測定ID
- **正しい値**: `NEXT_PUBLIC_GA_ID=G-5VS8BF91VH`
- **注意**: この値は絶対に変更しないこと
- この測定IDが正しく、SVS8BF91VHは間違いです
- **動作確認済み**: 2025年8月28日にリアルタイム計測で正常動作を確認
- **関連ファイル**: 
  - `.env.local` - 環境変数設定
  - `src/app/ga-provider.tsx` - Google Analytics プロバイダー
  - `src/lib/gtag.ts` - トラッキングライブラリ
  - `src/app/layout.tsx` - GAProvider読み込み

### API・データベース設定
#### YouTube API設定
- **YouTube Channel ID**: `UCxX3Eq8_KMl3AeYdhb5MklA` （ささよしチャンネル）
- **YouTube API Key**: `AIzaSyAsSclg9Wq9AEMTXAp8KZW4G5vgRUTyIXY`
- **Google Maps API Key**: `AIzaSyAH5oKyGm1EnibGH6JxlrEwMyRUIpzvEgI`
- **チャンネル確認URL**: https://www.youtube.com/channel/UCxX3Eq8_KMl3AeYdhb5MklA
- **使用方法**:
  ```bash
  export YOUTUBE_CHANNEL_ID="UCxX3Eq8_KMl3AeYdhb5MklA"
  export YOUTUBE_API_KEY="AIzaSyAsSclg9Wq9AEMTXAp8KZW4G5vgRUTyIXY"
  export GOOGLE_MAPS_API_KEY="AIzaSyAH5oKyGm1EnibGH6JxlrEwMyRUIpzvEgI"
  ```
- **注意**: これらの値は固定。今後変更時のみ更新する
- **関連ファイル**:
  - `scripts/check-youtube-and-create-articles.cjs` - YouTube動画記事作成スクリプト
  - `YOUTUBE_SYSTEM_FINAL_SETUP.md` - YouTube API設定ガイド

#### Gemini API設定（記事生成用）
- **API Key**: （セキュリティのため記載なし。`.env.local`とGitHub Secretsに設定済み）
- **使用モデル**: `gemini-2.5-flash-lite` （コスト最適化モデル）
- **価格**: $0.10/1M input + $0.40/1M output
- **月間コスト**: ¥3-4（toyamablog: 8-12件/月 + prorenata: 8件/月の合計）
- **コスト削減率**: 従来の月¥519から約99%削減
- **使用方法**:
  ```bash
  export GEMINI_API_KEY="[環境変数から取得]"
  ```
- **注意**:
  - APIキーはGitHubに公開しない（セキュリティ重要）
  - prorenataプロジェクトと共有使用、月間予算¥100以内で運用
- **関連ファイル**:
  - `scripts/check-youtube-and-create-articles.cjs` - 記事生成スクリプト（Gemini API使用）
  - `.env.local` - 環境変数設定（Gitignore対象）
  - `.github/workflows/youtube-check.yml` - 自動実行ワークフロー

#### Sanity CMS設定
- **プロジェクトID**: `aoxze287`
- **データセット**: `production`
- **API バージョン**: `2024-01-01`
- **API Token**: ⚠️  **期限切れ（2025-10-27確認）** - 新しいトークンの生成が必要
  - 旧トークン: `skkTjwpdrsjKKpaDxKVShzCSI7GMWE1r5TQdwl0b7LTylVPoAxzBg0oPqhtUQyfPjyvtZW2mu6nfUMNUJ`
  - 新トークン生成手順:
    1. `npx sanity dev` でSanity Studioを起動
    2. 管理画面から新しいAPIトークン（書き込み権限）を生成
    3. `.env.local`, GitHub Secrets, `~/.env_keys` を更新
- **使用方法**:
  ```bash
  export SANITY_API_TOKEN="[新しいトークンをここに設定]"
  ```
- **関連ファイル**:
  - `.env.local` - 環境変数設定
  - `src/lib/sanity.ts` - Sanityクライアント設定
  - `sanity.config.ts` - Sanity設定
  - `scripts/maintenance.cjs` - メンテナンススクリプト（書き込み権限必要）

#### Supabase設定（設定済み・未接続）
- **URL**: `https://toyama-blog-project.supabase.co` (デモURL)
- **Anon Key**: `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.demo_anon_key` (デモキー)
- **Service Role Key**: `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.demo_service_key` (デモキー)
- **状態**: コード実装済み、実際のプロジェクトへの接続が必要
- **データベーススキーマ**: users, categories, articles, comments, likes, page_views
- **関連ファイル**:
  - `lib/supabase.ts` - Supabaseクライアント設定
  - `.env.local` - 環境変数設定

#### その他の重要な環境変数
- **Revalidation Secret**: `REVALIDATE_SECRET=blog_revalidate_secret_2025_secure_token_xyz`
- **Database URL**: `DATABASE_URL=postgresql://postgres:password@localhost:54322/postgres`

## 自動実行スケジュール

- **状態**: 🟢 **稼働中**（2025-11-03より再開）
- **実行時刻**: 毎週土曜日 21:00 JST (土曜日 12:00 UTC)
- **実行頻度**: 週1回
- **処理件数**: 常に3件/週（前回処理済み動画の次から連続3本を対象）
- **ワークフロー**: `.github/workflows/youtube-check.yml`
- **内容**: YouTubeチャンネルの新着動画を検出し、Gemini AIで自動的にブログ記事を生成
- **スクリプト**: `scripts/check-youtube-and-create-articles.cjs`
- **使用AI**: Gemini 2.5 Flash-Lite（コスト最適化モデル）
- **月間コスト**: ¥3-4（予算¥100の3-4%）
- **進捗管理**: `.last-processed-video.json`で処理済み動画を追跡
- **必要な環境変数**:
  - `YOUTUBE_API_KEY` - YouTube Data API v3キー
  - `YOUTUBE_CHANNEL_ID` - ささよしチャンネルID
  - `SANITY_API_TOKEN` - Sanity書き込みトークン
  - `GEMINI_API_KEY` - Gemini API キー（prorenataと共有）
  - `ARTICLES_PER_RUN` - 1回の実行で処理する記事数（3または2）
- **手動実行方法**: GitHub Actionsページから「YouTube記事自動生成」ワークフローを手動トリガー

### 2. 週次メンテナンスチェック
- **実行時刻**: 毎週月曜日 AM 3:00 JST (日曜日 18:00 UTC)
- **実行頻度**: 週1回
- **ワークフロー**: `.github/workflows/weekly-maintenance.yml`
- **内容**: 全記事の品質チェック（必須フィールド、SEO、CLAUDE.mdルール準拠など）
- **スクリプト**: `scripts/maintenance.cjs report`
- **必要な環境変数**:
  - `SANITY_API_TOKEN` - Sanity読み取りトークン
- **エラー時の動作**: GitHub Issueを自動作成

### 3. メンテナンススクリプトコマンド
```bash
# 品質レポート生成（問題検出のみ）
node scripts/maintenance.cjs report

# 自動修正実行（修正可能な問題を自動修正）
node scripts/maintenance.cjs autofix

# 総合メンテナンス（report + autofix）
node scripts/maintenance.cjs all
```

## 記事作成基本方針

### 数字の積極的活用
- **読者に伝わりやすい場合は必ず数字を使用**
- 具体的な情報を提供するため数値データを含める
- 例：
  - 「多くの観光客」→「年間15万人の観光客」
  - 「歴史ある寺院」→「創建1200年の歴史ある寺院」  
  - 「アクセス良好」→「駅から徒歩5分」
  - 「人気のメニュー」→「1日限定50食の人気メニュー」

### 箇条書きの積極的使用
- **情報整理と読みやすさ向上のため箇条書きを活用**
- 複数の項目・特徴・手順などは箇条書きで記述
- モバイル読者への配慮として視覚的に分かりやすく構成

#### 箇条書き使用例：
- **アクセス情報**
  - 🚃 富山駅から電車で15分
  - 🚗 駐車場50台完備（無料）
  - 🚌 コミュニティバス「○○前」下車

- **おすすめポイント**
  - ✅ 地元食材100%使用
  - ✅ 創業明治時代の老舗
  - ✅ テレビ取材実績5回以上

- **営業情報**
  - 📅 営業時間：9:00-18:00
  - 🗓️ 定休日：火曜日
  - 💰 予算：1,000円-2,000円

### 記事構成と文字数
- **導入文**: 2-3行で記事の魅力を簡潔に
- **H2見出し**: 3つの主要セクション
- **H3見出し**: 必須ではなく、文章上どうしても必要な場合のみ使用
- **文字数**: 1,500文字から2,000文字（スマホ読みやすさ最優先）
- **まとめ**: 読者の行動を促す結び

### SEO最適化
- **タイトル**: 【地域名】を冒頭に配置
- **見出し**: キーワードを自然に含める
- **タグ**: 10個程度で最適化、地域名と特徴を組み合わせ
- **excerpt（重要）**:
  - **文字数**: 50-160文字程度
  - **内容要件**: 訪問者が興味を持つ具体的で魅力的な説明
  - **SEO**: キーワードを自然に含める
  - **禁止表現**:
    - 「富山のくせに」「魅力を全力で」などの定型表現は使用禁止
    - タイトルをそのまま載せることは禁止（ユーザビリティに反する）
  - **推奨**: 記事の内容から具体的な魅力を抽出し、読者の興味をそそる表現を使う
  - **メンテナンス**: `scripts/maintenance.cjs`で品質チェック・自動修正が可能

### YouTube動画連携
- **動画がある記事**: 内容と完全一致させる
- **サムネイル**: 記事カードに自動表示
- **YouTubeバッジ**: 動画付き記事の識別用

## クラウドルール（厳格遵守）

### 【最重要】レイアウト配置規則
- **記事構造の厳格順序（全記事統一）**: H1タイトル → 動画 → 見出し → もくじ → H2本文記事 → まとめ → マップ → 公式・SNSリンク → タグの順番
- **H1タイトル**: 記事の最上部に配置、【地域名】形式を維持
- **動画配置**: タイトル直下、YouTube埋め込み動画を配置
- **見出し・もくじ**: 記事の構造を示すナビゲーション要素
- **本文記事**: H2見出しで構成されたメインコンテンツ（H3は必須ではなく、文章上どうしても必要な場合のみ使用）
- **まとめセクション（厳格ルール）**: 
  - H2タグで「まとめ」見出しを配置（全記事統一）
  - 記事の要約と読者への訴求を行う内容を記述
  - まとめセクションは全記事必須
- **マップセクション（厳格ルール）**:
  - 「地図」タイトル削除（マップのみ表示）
  - Googleマップiframeのみを配置
  - テキスト説明不要、マップ単体で表示
  - まとめセクションの後、公式・SNSリンクより上に配置
- **公式・SNSリンクセクション（厳格ルール）**:
  - Googleマップの直下、タグセクションより上に配置
  - 公式サイト、Instagram、Twitter等のリンクを配置
  - 絵文字付きで視覚的に分かりやすく構成
  - モバイル読者への配慮を最優先とした情報整理
- **タグセクション（厳格ルール）**:
  - 「タグ」タイトル削除
  - タグのみを表示、見出し不要
  - 記事の最下部に配置
- **PortableText除外**: PortableTextコンポーネント内でのGoogleマップ表示は完全禁止
- **構造統一**: 全記事で同一の構造を維持し、ユーザビリティを統一する

### 【最重要】カテゴリ設定規則
- **【】内の地域名使用**: 記事タイトルの【】内の文字をカテゴリとして使用する
- **例**: 【富山市】→ カテゴリ: "富山市"、【高岡市】→ カテゴリ: "高岡市"
- **禁止カテゴリ**: 「グルメ」「観光」等の汎用カテゴリは使用禁止
- **地域名優先**: 必ず地域名をカテゴリとし、ジャンル分けは行わない
- **統一性維持**: 全記事で地域名カテゴリの統一性を維持する
- **自動修正**: 間違ったカテゴリが設定された場合は即座に修正する

### タイトル処理規則
- **#shorts削除（全記事対象）**: 記事タイトルに含まれる「#shorts」（大文字小文字問わず）は表示時に自動削除する
- 既存の記事・今後追加される記事の全てが対象
- PostCardコンポーネントと記事詳細ページの両方で適用
- 前後の空白も含めて削除し、trim()で整形する
- データベース内のタイトルは変更せず、表示時のみ処理する

### 本文内ハッシュタグ禁止
- **本文中で「#shorts」を使用しない**（動画紹介の際も同様）
- 既存記事に残っている場合はメンテナンススクリプトが自動で除去
- 新規記事を追加する際は初めから本文へ書かないこと

### タグ最適化規則
- **記事本文分析必須**: 記事内容を詳細に分析し、本文に含まれる要素に基づいてタグを整理する
- **10個程度で最適化**: SEO効果を最大化するため、厳選した10個程度のタグを設定
- **既存記事対象**: 既存の全記事のタグを記事内容と照合し、不適切なタグを削除・適切なタグを追加する
- **新規記事対象**: 今後追加される記事も同様に、本文内容に基づいた正確なタグ付けを実行
- **内容整合性**: 記事で言及されていない地名・施設・カテゴリのタグは削除する
- **精度向上**: 記事で具体的に紹介している地名・施設・特徴を正確にタグに反映する
- **継続実行**: 記事追加・編集時は必ずタグの見直しと最適化を実行する

### データ残存問題対策（最優先深刻問題）
- **古いデータ残存の深刻性認識**: Sanityデータベース内の古いブロックデータがクラウドルール違反を継続させる最重大問題
- **最優先対応義務**: 「古いデータが残存している可能性」が指摘された場合、他の作業を停止して最優先で解決する
- **データクリーニング必須**: コード修正と併せてSanityデータベースの古いブロック除去を実行する
- **根本原因解決**: 表面的なコード修正ではなく、データレベルでの問題解決を最優先とする
- **予防的データ管理**: 将来的なデータ残存問題を防ぐため、データベース構造の整合性を維持する
- **深刻問題カテゴリ**: データ残存問題を画像消失・リンク破壊と同等の最重大問題として扱う

### 画像表示保護規則（絶対遵守）
- **ヒーロー画像**: `/images/toyama-hero.png`のパスとImage コンポーネントの実装を絶対に変更・削除しない
- **サムネイル画像**: PostCardコンポーネントのサムネイル表示機能を絶対に変更・削除しない
- **画像最適化設定**: `next.config.ts`の`unoptimized: true`設定を絶対に変更しない
- **エラーハンドリング**: 画像読み込み失敗時のフォールバック処理を絶対に削除しない
- **YouTubeサムネイル**: `i.ytimg.com`ドメインとhqdefault.jpg使用を維持する
- これらの設定変更により画像が表示されなくなることを絶対に避ける

### 副作用防止最重要規則（絶対遵守）
- **画像消失厳禁**: どんな指示・修正を行っても、ヒーロー画像・サムネイル画像が消失することは絶対に許可しない
- **リンク機能破壊厳禁**: 記事へのリンク、クリック機能を破壊することは絶対に許可しない
- **基本機能保護**: 画像表示、リンク、ナビゲーション等の基本機能を破壊してはならない
- **変更前必須チェック**: コード変更前に必ず基本機能への影響をチェックし、影響がある場合は代替手段を検討する
- **完全性維持**: パフォーマンス改善、機能追加、バグ修正等のいかなる理由でも基本機能を破壊してはならない
- **即座復旧**: もし基本機能が破壊された場合は、他の作業を停止して最優先で復旧する
- **予防的保護**: 関連コード変更時は、変更前後で必ず動作確認を行い、問題があれば変更を取り消す
- **ゼロトレランス**: 「指示の副作用で基本機能が破壊される」事象の発生をゼロにする
- **重大問題認識**: 画像消失・リンク破壊・機能停止は最重大問題として即座に対処する

### 確実性保証規則
- **「はず」「予想」禁止**: 技術的な結果について推測的な表現を使用しない
- **確実な確認**: 修正後は実際の動作を確認し、確実に動作することを保証する
- **結果責任**: 「はずです」「と思います」等の曖昧な表現ではなく、確実な結果を提供する
- **検証必須**: 変更を実装した場合は必ず動作検証を行い、問題があれば完全に修正する

### 記事メンテナンス作業規則（全記事対象）
- **包括的分析必須**: 「全記事メンテナンス」要求時は全記事の現状分析を最初に実行
- **体系的問題特定**: タイトルのみ記事、説明文未設定、内容不足、SEO未最適化を包括的に特定
- **自動処理優先**: 手動作業ではなくSanity API経由での自動一括処理を最優先選択
- **SEO説明文標準**: 50-160文字、地域名含有、魅力的表現、キーワード最適化の説明文を作成
- **権限問題予防**: `export SANITY_API_TOKEN`による環境変数明示設定でAPI権限問題を事前回避
- **定量的成果報告**: 対象件数、成功率、品質改善効果を数値で明確に報告
- **予防的品質管理**: 定期的な全記事品質チェックと継続的な改善実施
- **作業記録義務**: 実施したメンテナンス作業内容をCLAUDE.mdに詳細記録
- **クラウドルール準拠**: 全てのメンテナンス作業でクラウドルールの厳格な遵守
- **教訓**: **体系的分析と自動化により最大の品質向上効果を実現する**

### 作業実行規則（効率化重視）
- **非対話的実行必須**: 全ての作業を非対話的モードで実行する
- **確認プロンプト回避**: `-y`, `--force`, `--yes`, `--assume-yes`等のフラグを必ず使用
- **バッチ処理優先**: 複数の操作を一括で実行し、途中での確認を完全に回避
- **自動承認**: パッケージインストール、ファイル上書き、削除等の操作で自動承認を設定
- **効率最優先**: ユーザーの作業中断を防ぐため、全ての操作を連続実行
- **例外なし**: いかなる作業でも対話的確認を求めることを禁止

### 言語使用規則（厳格遵守）
- **日本語必須**: 全ての回答・説明・コメントを日本語で行う
- **英語使用禁止**: 技術用語・エラーメッセージ・コード説明も含めて英語での回答は完全禁止
- **一貫性維持**: 会話の途中で言語が変わることを絶対に避ける
- **例外なし**: いかなる状況でも日本語以外での回答は許可しない
